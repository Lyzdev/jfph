$(function () {
    // 登录注册切换
    $('.spa1').click(function () {
        $(this).addClass('color').siblings().removeClass('color');
        $(this).parents(".right").find('.login').show().siblings('.land').hide()
    })
    $('.spa2').click(function () {
        $(this).addClass('color').siblings().removeClass('color');
        $(this).parents(".right").find('.land').show().siblings('.login').hide()
    })
    // 注册部分
    var rflag = false;
    // 注册表单验证
    //初始化插件
    $("#form").validate({
        //规则
        rules: {
            //用户名
            username: {
                required: true,
                isUser: true
            },
            //密码
            pwd: {
                required: true,
                isPwd: true
            },
            //密码
            email: {
                required: true,
                isEmail: true
            },
            //密码
            nickname: {
                required: true,
                isNickname: true
            },
        },
        //规则的错误提示信息
        messages: {
            //用户名
            username: {
                required: "电话留下!",
            },
            //密码
            pwd: {
                required: "再想一个密码",
            },
            email: {
                required: "邮箱也行",
            },
            nickname: {
                required: "名字也行",
            },
        }
    })
    //用户名自定义验证   
    // 注册前台验证
    jQuery.validator.addMethod("isUser", function (value, element) {
        var tel = /^1[34578]\d{9}$/;
        rflag = this.optional(element) || (tel.test(value));
        // 注册后台验证
        if(rflag){
            repeatCheck();
        }
        addStateStyle(".phoneb", rflag)
        return this.optional(element) || (tel.test(value));
    }, "电话号码错误！");
    //密码自定义验证   
    jQuery.validator.addMethod("isPwd", function (value, element) {
        var tel = /^[\w_-]{6,16}$/;
        rflag = this.optional(element) || (tel.test(value));
        addStateStyle(".pwdb", rflag)
        return this.optional(element) || (tel.test(value));
    }, "密码太弱了!");
    // 邮箱验证
    jQuery.validator.addMethod("isEmail", function (value, element) {
        var tel = /^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/;
        rflag = this.optional(element) || (tel.test(value));
        addStateStyle(".emailb", rflag);
        return this.optional(element) || (tel.test(value));
    }, "邮箱错啦!");
    // 昵称验证
    jQuery.validator.addMethod("isNickname", function (value, element) {
        var tel = /^[a-zA-Z]{1}[0-9a-zA-Z_]{1,}$/;
        rflag = this.optional(element) || (tel.test(value));
        addStateStyle(".nicknameb", rflag);
        return this.optional(element) || (tel.test(value));
    }, "昵称太low!");
    // 注册后台验证
    // $("#rusername").on("blur", function () {
    //     if ($("#rusername").val() === "") {
    //         rflag = false;
    //         addStateStyle("#rusername", rflag)
    //         return false;
    //     }
    //     //注册 表单验证不通过，退出
    //     // if(!rflag){
    //     //     rflag=true;
    //     //     return
    //     // }
    //     repeatCheck();
    // })
    // 填写时去除状态样式
    $("#rusername").on("focusin", function () {
        removeStateStyle("#rusername");
    })
    $("#pwd").on("focusin", function () {
        removeStateStyle("#pwd")
    })
    $("#email").on("focusin", function () {
        removeStateStyle("#email")
    })
    $("#nickname").on("focusin", function () {
        removeStateStyle("#nickname")
    })
    // 重复检查
    function repeatCheck() {
        $.ajax({
            type: "get",
            url: "http://172.16.16.127:8282/accrepeat.php",
            async: false,
            data: {
                username: $("#rusername").val(),
            },
            success: function (response) {
                var result = response === "ok" ? true : false;
                rflag = result;
                addStateStyle(".rtel", result);
            }
        });
    }
    // 验证成功添加状态样式
    function addStateStyle(obj, flag) {
        // $(obj).css("borderColor", "green");
        if (flag) {
            $(obj).css("borderColor", "green");
            $(obj).find(".r-tips").css("color", "green").html("√");
        } else {
            $(obj).css("borderColor", "red");
            $(obj).find(".r-tips").css("color", "red").html("X");
        }
    }
    // 输入时去除状态样式
    function removeStateStyle(obj) {
        $(obj).closest("div").css("borderColor", "#ccc");
        $(obj).siblings(".r-tips").html("");
    }
    // 注册按钮事件
    $(".sub-btn").on("click", function () {
        if ($("#rusername").val() ==""||$("#pwd").val() ==""||$("#email").val() ==""||$("#nickname").val() =="") {
            alert("请完整填写信息！")
            rflag = false;
            return false;
        }
        repeatCheck();
        if (!rflag) {
            // console.log(3)
            return false;
        } else {
            var readCheck = $("#readprop").prop("checked");
            if (!readCheck) {
                alert("请阅读协议并勾选！！")
                return false;
                // console.log(2)
            }
        }
        $.ajax({
            type: "post",
            url: "http://172.16.16.127:8282/reg.php",
            data: {
                username: $("#rusername").val(),
                pwd: $("#pwd").val(),
                email: $("#email").val(),
                nickname: $("#nickname").val()
            },
            success: function (response) {
                if (response === "ok") {
                    alert("注册成功");
                    $('.spa2').trigger("click");
                    $("#rusername").val('');
                    $("#pwd").val('');
                    $("#email").val('');
                    $("#nickname").val('');
                    removeStateStyle("#rusername");
                    removeStateStyle("#pwd");
                    removeStateStyle("#email")
                    removeStateStyle("#nickname")
                    $("#readprop").prop("checked",false);
                    
                }
            }
        });
        return false;
    })
    $("#readprop").click(function () {
        console.log($("#readprop").prop("checked"));
    })
    // 登录部分
    $("#lusername").on("focusin", function () {
        removeStateStyle("#lusername");
    })
    $("#lpwd").on("focusin", function () {
        removeStateStyle("#lpwd")
    })
    $(".log-btn").on("click",function(){
            $.ajax({
                type: "post",
                url: "http://172.16.16.127:8282/login.php",
                data: {
                    username:$("#lusername").val(),
                    pwd:$("#lpwd").val()
                },
                success: function (response) {
                    // console.log(Number(response))
                    if(Number(response)){
                        var endTime=new Date().getTime() +  30 * 60 * 1000;
                        localStorage.setItem("id",response);
                        localStorage.setItem("username",$("#lusername").val());
                        localStorage.setItem("endtime",endTime);
                        alert(`   ${$("#lusername").val()},   欢迎使用！`)
                        location.href="/";
                    }else{
                        alert("账号或密码错误")
                        addStateStyle(".lusernameb", false)
                        addStateStyle(".lpwdb", false)
                    }
                }
            });
            return false;
        })
    // 登录自动切换
    function changelrTab(){
        var hash=location.hash;
        if(hash=="#login"){
            $(".spa2").trigger("click");
        }else if(hash=="#register"){
            $(".spa1").trigger("click");
        }else{return false};
    }
    changelrTab()
})